dist: xenial

language: python
python:
  - 3.4
  - 3.5
  - 3.6
  - 3.7

before_install:
  # Install PowerShell Core.
  - wget -q https://packages.microsoft.com/config/ubuntu/16.04/packages-microsoft-prod.deb
  - sudo dpkg -i packages-microsoft-prod.deb
  - sudo apt-get update
  - sudo apt-get install --no-install-recommends -y powershell

install:
  - pip install -r requirements-test.txt

script:
  - flake8 .

  # Since we develop a library, we want to make sure that it properly runs
  # after installation. We already ran into an issue when some files were
  # forgotten to be included in package_data and it was not caught by tests.

  # So first we run unit tests against raw source code and report coverage.
  - pytest -v tests/ --cov=m2cgen/ --ignore=tests/e2e/
  - coveralls

  # Then we install it as a library, remove source code and run e2e tests.
  - python setup.py install
  - rm -rfd m2cgen/
  - pytest -v tests/e2e/
